{% extends 'base.html' %}
{% load static %}

{% block title %}–ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<div class="moderator-app">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-wrapper">
                <img src="{% static 'assets/favicon.ico' %}" alt="Site Logo" class="sidebar-logo">
                <h1 class="sidebar-title">Code-io</h1>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><button data-target="users" class="sidebar-link active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button></li>
                <li><button data-target="courses" class="sidebar-link">üìö –ö—É—Ä—Å—ã</button></li>
                <li><button data-target="topics" class="sidebar-link">üìå –¢–µ–º—ã</button></li>
                <li><button data-target="course_reports" class="sidebar-link">‚ö†Ô∏è –ñ–∞–ª–æ–±—ã –Ω–∞ –∫—É—Ä—Å—ã</button></li>
                <li><button data-target="topic_reports" class="sidebar-link">üö© –ñ–∞–ª–æ–±—ã –Ω–∞ —Ç–µ–º—ã</button></li>
            </ul>
        </nav>
    </aside>

    <main class="content">
        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <section id="users" class="section active">
            <div class="section-header"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2></div>
            <div class="table-container">
                <table class="moderator-table">
                    <thead><tr><th>ID</th><th>Email</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody>
                        {% for u in users %}
                        <tr data-user-id="{{ u.id }}">
                            <td>{{ u.id }}</td>
                            <td><a href="{% url 'profile' u.id %}">{{ u.email }}</a></td>
                            <td class="user-role">
                                {% if u.is_staff %}Staff{% elif u.is_moderator %}Moderator{% else %}User{% endif %}
                            </td>
                            <td class="actions">
                                {% if not u.is_moderator and not u.is_staff %}
                                    <button class="btn btn--primary btn-promote">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
                                {% elif u.is_moderator %}
                                    <button class="btn btn--danger btn-demote">–°–Ω—è—Ç—å</button>
                                {% endif %}
                                {% if not u.is_staff or request.user.is_staff %}
                                    <button class="btn btn--danger btn-delete-user">–£–¥–∞–ª–∏—Ç—å</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- –ö—É—Ä—Å—ã -->
        <section id="courses" class="section">
            <div class="section-header"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏</h2></div>
            <div class="table-container">
                <table class="moderator-table">
                    <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ê–≤—Ç–æ—Ä</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody>
                        {% for c in courses %}
                        <tr data-course-id="{{ c.course_id }}">
                            <td>{{ c.course_id }}</td>
                            <td><a href="{% url 'course' c.course_id %}">{{ c.title }}</a></td>
                            <td>
                                {% if c.author %}
                                    <a href="{% url 'profile' c.author.id %}">{{ c.author.email }}</a>
                                {% else %}
                                    <span class="text-muted">–ê–≤—Ç–æ—Ä —É–¥–∞–ª—ë–Ω</span>
                                {% endif %}
                            </td>
                            <td class="actions">
                                <button class="btn btn--danger btn-delete-course">–£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- –¢–µ–º—ã -->
        <section id="topics" class="section">
            <div class="section-header"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏</h2></div>
            <div class="table-container">
                <table class="moderator-table">
                    <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ê–≤—Ç–æ—Ä</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody>
                        {% for t in topics %}
                        <tr data-topic-id="{{ t.id }}">
                            <td>{{ t.id }}</td>
                            <td>{{ t.name }}</td>
                            <td>
                                {% if t.author and t.author.id %}
                                    <a href="{% url 'profile' t.author.id %}">{{ t.author.email }}</a>
                                {% else %}
                                    <span class="text-muted">–ê–≤—Ç–æ—Ä —É–¥–∞–ª—ë–Ω</span>
                                {% endif %}
                            </td>
                            <td>{{ t.created_at|date:"d.m.Y" }}</td>
                            <td class="actions">
                                <button class="btn btn--danger btn-delete-topic">–£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- –ñ–∞–ª–æ–±—ã –Ω–∞ –∫—É—Ä—Å—ã -->
        <section id="course_reports" class="section">
            <div class="section-header"><h2>–ñ–∞–ª–æ–±—ã –Ω–∞ –∫—É—Ä—Å—ã</h2></div>
            <div class="table-container">
                <table class="moderator-table">
                    <thead><tr><th>ID</th><th>–ö—É—Ä—Å</th><th>–ê–≤—Ç–æ—Ä</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody>
                        {% for r in course_reports %}
                        <tr data-report-id="{{ r.id }}" data-course-id="{{ r.course.course_id }}">
                            <td>{{ r.id }}</td>
                            <td><a href="{% url 'course' r.course.course_id %}">{{ r.course.title }}</a></td>
                            <td><a href="{% url 'profile' r.author.id %}">{{ r.author.email }}</a></td>
                            <td>{{ r.reason }}</td>
                            <td class="actions">
                                <button class="btn btn--danger btn-delete-course-report">–£–¥–∞–ª–∏—Ç—å –∂–∞–ª–æ–±—É</button>
                                <button class="btn btn--danger btn-delete-course-in-report">–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- –ñ–∞–ª–æ–±—ã –Ω–∞ —Ç–µ–º—ã -->
        <section id="topic_reports" class="section">
            <div class="section-header"><h2>–ñ–∞–ª–æ–±—ã –Ω–∞ —Ç–µ–º—ã</h2></div>
            <div class="table-container">
                <table class="moderator-table">
                    <thead><tr><th>ID</th><th>–ö—É—Ä—Å</th><th>–ê–≤—Ç–æ—Ä</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody>
                        {% for tr in topic_reports %}
                        <tr data-topic-report-id="{{ tr.id }}">
                            <td>{{ tr.id }}</td>
                            <td><a href="{% url 'course' tr.course.course_id %}">{{ tr.course.title }}</a></td>
                            <td><a href="{% url 'profile' tr.author.id %}">{{ tr.author.email }}</a></td>
                            <td>{{ tr.get_reason_display }}</td>
                            <td>{{ tr.created_at|date:"d.m.Y" }}</td>
                            <td class="actions">
                                <button class="btn btn--danger btn-delete-topic-report">–£–¥–∞–ª–∏—Ç—å –∂–∞–ª–æ–±—É</button>
                                <button class="btn btn--danger btn-delete-topic-in-report">–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<style>
:root {
    --primary: #28a745;
    --primary-hover: #218838;
    --danger: #dc3545;
    --danger-hover: #bb2d3b;
    --background: #f8f9fa;
    --surface: #ffffff;
    --text: #212529;
    --border: #dee2e6;
    --text-muted: #6c757d;
}

[data-theme="dark"] {
    --primary: #4dabf7;
    --primary-hover: #339af0;
    --danger: #ff6b6b;
    --danger-hover: #ff5252;
    --background: #1a1a1a;
    --surface: #2d2d2d;
    --text: #f8f9fa;
    --border: #495057;
    --text-muted: #adb5bd;
}

.moderator-app {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: 100vh;
    background: var(--background);
}

.sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 1rem;
    position: sticky;
    top: 0;
    height: 100vh;
}

.logo-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.sidebar-logo {
    width: 40px;
    height: 40px;
    object-fit: contain;
}

.sidebar-title {
    font-size: 1.25rem;
    color: var(--primary);
    margin: 0;
}

.sidebar-nav {
    padding: 1rem 0;
}

.sidebar-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.sidebar-nav button {
    width: 100%;
    text-align: left;
    padding: 12px 20px;
    margin: 0;
    border-radius: 8px;
    border: none;
    background: none;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    font-size: 0.95rem;
    cursor: pointer;
}

.sidebar-nav button:hover {
    background: rgba(0,0,0,0.05);
}

.sidebar-nav button.active {
    background: var(--primary);
    color: white;
}

.content {
    padding: 2rem;
    background: var(--background);
}

.section {
    display: none;
    animation: fadeIn 0.3s ease;
}

.section.active {
    display: block;
}

.table-container {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
}

.moderator-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
}

.moderator-table th,
.moderator-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    text-align: left;
}

.moderator-table th {
    background: rgba(0,0,0,0.03);
    font-weight: 600;
}

.moderator-table a {
    color: var(--primary);
    text-decoration: none;
    transition: opacity 0.2s;
}

.moderator-table a:hover {
    text-decoration: underline;
    opacity: 0.9;
}

.text-muted {
    color: var(--text-muted);
    font-style: italic;
}

.actions {
    white-space: nowrap;
    display: flex;
    gap: 8px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn--primary {
    background: var(--primary);
    color: white;
}

.btn--primary:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
}

.btn--danger {
    background: var(--danger);
    color: white;
}

.btn--danger:hover {
    background: var(--danger-hover);
    transform: translateY(-1px);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
    .moderator-app {
        grid-template-columns: 1fr;
    }

    .sidebar {
        position: static;
        height: auto;
    }

    .content {
        padding: 1rem;
    }

    .moderator-table {
        display: block;
        overflow-x: auto;
    }
}
</style>

<script>
document.querySelectorAll('.sidebar-nav button').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelector('.sidebar-nav button.active').classList.remove('active');
        this.classList.add('active');
        document.querySelector('.section.active').classList.remove('active');
        document.getElementById(this.dataset.target).classList.add('active');
    });
});

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

const ajax = async (url, method, data) => {
    const options = {
        method,
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    };

    if(data) {
        options.body = new URLSearchParams(data);
    }

    try {
        const response = await fetch(url, options);
        if(!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        return response.json();
    } catch(error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏');
        throw error;
    }
};

document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const row = btn.closest('tr');
        try {
            let url, data;

            if(btn.classList.contains('btn-promote')) {
                url = "{% url 'add_moderator' %}";
                data = { user_id: row.dataset.userId };
                const res = await ajax(url, 'POST', data);
                if(res.status === 'ok') {
                    btn.textContent = '–°–Ω—è—Ç—å';
                    btn.classList.replace('btn--primary', 'btn--danger');
                    btn.classList.replace('btn-promote', 'btn-demote');
                    row.querySelector('.user-role').textContent = 'Moderator';
                }
            }
            else if(btn.classList.contains('btn-demote')) {
                url = "{% url 'add_moderator' %}";
                data = { user_id: row.dataset.userId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') {
                    btn.textContent = '–ù–∞–∑–Ω–∞—á–∏—Ç—å';
                    btn.classList.replace('btn--danger', 'btn--primary');
                    btn.classList.replace('btn-demote', 'btn-promote');
                    row.querySelector('.user-role').textContent = 'User';
                }
            }
            else if(btn.classList.contains('btn-delete-user')) {
                url = "{% url 'delete_user' %}";
                data = { user_id: row.dataset.userId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') row.remove();
            }

            else if(btn.classList.contains('btn-delete-course')) {
                url = "{% url 'delete_course' %}";
                data = { course_id: row.dataset.courseId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') row.remove();
            }

            else if(btn.classList.contains('btn-delete-course-report')) {
                url = "{% url 'delete_course_report' %}";
                data = { report_id: row.dataset.reportId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') row.remove();
            }
            else if(btn.classList.contains('btn-delete-course-in-report')) {
                url = "{% url 'delete_course' %}";
                data = { course_id: row.dataset.courseId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') row.remove();
            }

            else if(btn.classList.contains('btn-delete-topic')) {
                url = "{% url 'delete_topic' %}";
                data = { topic_id: row.dataset.topicId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') row.remove();
            }

            else if(btn.classList.contains('btn-delete-topic-report')) {
                url = "{% url 'delete_topic_report' %}";
                data = { report_id: row.dataset.topicReportId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') row.remove();
            }
            else if(btn.classList.contains('btn-delete-topic-in-report')) {
                url = "{% url 'delete_topic' %}";
                data = { topic_id: row.dataset.topicId };
                const res = await ajax(url, 'DELETE', data);
                if(res.status === 'ok') row.remove();
            }

        } catch(error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    });
});
</script>
{% endblock %}
