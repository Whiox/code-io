{% extends 'base.html' %}
{% load static %}

{% block title %}Профиль пользователя{% endblock %}

{% block content %}
    <div class="user-profile-page">
        <div class="up-container">
            {% if is_owner %}
                <div class="up-actions">
                    <button class="up-button up-button--edit" id="up-edit-btn" aria-label="Редактировать профиль">
                        <img src="{% static 'assets/edit.svg' %}" alt="Редактировать">
                    </button>
                </div>
            {% endif %}

            <div class="up-header">
                <img src="{% static 'assets/profile-default.png' %}"
                     alt="Аватар пользователя" class="up-avatar">
                <h1 class="up-username">{{ username }}</h1>
            </div>

            <div class="up-section">
                <div class="up-section__title">О себе</div>
                <p class="up-section__text">{{ user_profile.about }}</p>
            </div>

            <div class="up-section">
                <div class="up-section__title">Контакты</div>
                {% if user_profile.email %}
                    <p class="up-section__text">Email: {{ user_profile.email }}</p>
                {% else %}
                    <p class="up-section__text">Не указано</p>
                {% endif %}
            </div>

            {% if social_network %}

                <div class="up-section">
                    <div class="up-section__title">Социальные сети</div>
                    <div class="up-social-links">
                        {% for sn in social_network %}
                            <a class="up-social-links__item" href="{{ sn.linc }}" target="_blank" rel="noopener">
                                {{ sn.label }}
                            </a>
                        {% empty %}
                            <p class="up-section__text">Не указаны</p>
                        {% endfor %}
                    </div>
                </div>

            {% endif %}

            {% if interest %}

                <div class="up-section">
                    <div class="up-section__title">Технологии</div>
                    <ul class="up-tech-list">
                        {% for tech in interest %}
                            <li class="up-tech-list__item">{{ tech.label }}</li>
                        {% empty %}
                            <li class="up-tech-list__item">Не указаны</li>
                        {% endfor %}
                    </ul>
                </div>

            {% endif %}

        </div>

        {% if is_owner %}
            <div class="up-modal" id="up-modal">
                <div class="up-modal__content">
                    <span class="up-modal__close" id="up-modal-close" aria-label="Закрыть">&times;</span>
                    <h2 class="up-modal__title">Редактирование профиля</h2>

                    <form method="post" class="up-form">
                        {% csrf_token %}
                        <label class="up-form__label" for="username">Имя</label>
                        <input class="up-form__input" type="text" name="username" id="username" value="{{ username }}">

                        <label class="up-form__label" for="about">О себе</label>
                        <textarea class="up-form__textarea" name="about" id="about"
                                  rows="4">{{ user_profile.about }}</textarea>

                        <label class="up-form__label" for="email">Email</label>
                        <input class="up-form__input" type="email" name="email" id="email"
                               value="{{ user_profile.email }}">

                        <label class="up-form__label" for="tech-input">Добавить технологию</label>
                        <input class="up-form__input" type="text" id="tech-input" placeholder="Например, Django">
                        <button class="up-form__btn up-form__btn--add-tech" type="button" id="add-tech-btn">Добавить
                        </button>

                        <ul class="up-form__tech-chips" id="tech-chips">
                            {% for tech in interest %}
                                <li class="up-form__tech-chip">
                                    <span>{{ tech.label }}</span>
                                    <button type="button" class="up-form__tech-remove">×</button>
                                    <input type="hidden" name="technologies" value="{{ tech.label }}">
                                </li>
                            {% endfor %}
                        </ul>

                        <button class="up-form__btn" type="submit">Сохранить профиль</button>

                        <form method="post" class="up-form up-form--inline-delete">
                            {% csrf_token %}
                            <button class="up-button up-button--delete"
                                    name="action" value="delete_account"
                                    onclick="return confirm('Удалить аккаунт? Это действие необратимо.')"
                                    aria-label="Удалить аккаунт">
                                Удалить аккаунт
                            </button>
                        </form>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        document.getElementById('up-edit-btn')?.addEventListener('click', () => {
            document.getElementById('up-modal').style.display = 'flex';
        });
        document.getElementById('up-modal-close')?.addEventListener('click', () => {
            document.getElementById('up-modal').style.display = 'none';
        });
        window.addEventListener('click', e => {
            if (e.target.id === 'up-modal') {
                document.getElementById('up-modal').style.display = 'none';
            }
        });

        const addBtn = document.getElementById('add-tech-btn');
        const techInput = document.getElementById('tech-input');
        const chipsList = document.getElementById('tech-chips');

        addBtn?.addEventListener('click', () => {
            const val = techInput.value.trim();
            if (!val) return;
            const li = document.createElement('li');
            li.className = 'up-form__tech-chip';
            li.innerHTML = `<span>${val}</span><button type=\"button\" class=\"up-form__tech-remove\">×</button>` +
                `<input type=\"hidden\" name=\"technologies\" value=\"${val}\">`;
            chipsList.append(li);
            techInput.value = '';
        });

        chipsList?.addEventListener('click', e => {
            if (e.target.matches('.up-form__tech-remove')) {
                e.target.closest('li').remove();
            }
        });
    </script>
{% endblock %}
